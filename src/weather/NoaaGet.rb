require 'net/ftp'
require 'zlib'
require 'fileutils'
require 'tempfile'

usaf = ['725650']
=begin
usaf = ['997380',
        '998427',
        '700260',
        '998425',
        '911650',
        '917650',
        '997171',
        '785430',
        '785510',
        '725170',
        '722160',
        '725945',
        '747540',
        '724676',
        '726457',
        '723150',
        '725080',
        '723270',
        '726810',
        '722136',
        '722880',
        '724060',
        '724016',
        '725450',
        '725240',
        '722445',
        '723140',
        '724280',
        '724450',
        '724140',
        '725825',
        '725260',
        '726480',
        '722010',
        '727530',
        '726650',
        '727570',
        '722576',
        '726350',
        '724677',
        '723230',
        '725287',
        '722430',
        '723011',
        '727470',
        '725035',
        '725776',
        '744860',
        '727535',
        '722950',
        '722970',
        '726430',
        '726379',
        '723990',
        '725970',
        '724555',
        '726400',
        '722040',
        '727676',
        '727430',
        '727730',
        '723080',
        '727845',
        '722868',
        '725915',
        '722108',
        '722900',
        '722530',
        '722070',
        '725350',
        '722897',
        '724230',
        '724754',
        '725720',
        '723510',
        '724340',
        '724957',
        '725865',
        '722448',
        '722166',
        '722039',
        '723400',
        '702730',
        '702190',
        '911900',
        '703870',
        '703610',
        '723650',
        '725060',
        '722560',
        '723630',
        '726357',
        '725150',
        '722280',
        '726770',
        '727976',
        '725090',
        '726785',
        '722317',
        '726170',
        '725280',
        '725210',
        '723240',
        '727344',
        '727440',
        '725690',
        '722255',
        '724210',
        '722580',
        '724290',
        '724050',
        '722590',
        '722268',
        '725460',
        '725370',
        '726930',
        '724320',
        '723095',
        '723035',
        '724515',
        '727850',
        '724760',
        '747570',
        '723120',
        '727455',
        '727720',
        '722505',
        '724500',
        '725785',
        '727437',
        '724380',
        '722350',
        '725645',
        '723575',
        '725207',
        '722400',
        '722520',
        '727830',
        '722650',
        '724460',
        '725340',
        '724915',
        '747910',
        '723069',
        '723530',
        '725500',
        '725300',
        '726917',
        '724350',
        '722030',
        '723086',
        '727347',
        '726060',
        '726620',
        '726835',
        '725740',
        '725290',
        '723925',
        '724400',
        '722480',
        '722630',
        '724390',
        '722115',
        '725038',
        '726387',
        '725866',
        '722800',
        '785140',
        '702610',
        '727790',
        '911820',
        '912850',
        '911975',
        '785203',
        '703860',
        '700637',
        '725128',
        '785260',
        '722660',
        '726590',
        '724070',
        '722180',
        '726390',
        '722190',
        '722540',
        '725130',
        '722500',
        '726797',
        '723100',
        '724755',
        '722080',
        '726700',
        '724660',
        '722056',
        '727450',
        '724625',
        '727573',
        '725020',
        '723890',
        '723750',
        '726370',
        '726510',
        '723440',
        '725330',
        '722447',
        '722146',
        '726450',
        '723307',
        '722688',
        '725155',
        '722060',
        '723495',
        '725390',
        '722405',
        '722506',
        '743945',
        '725440',
        '726580',
        '725066',
        '725095',
        '726980',
        '724080',
        '725320',
        '722348',
        '725780',
        '722220',
        '725070',
        '727415',
        '724010',
        '726440',
        '727930',
        '723940',
        '722977',
        '722110',
        '723181',
        '723560',
        '722740',
        '722210',
        '749307',
        '703810',
        '703950',
        '702000',
        '701330',
        '725180',
        '725480',
        '723840',
        '726070',
        '727640',
        '727550',
        '724397',
        '722410',
        '726555',
        '722510',
        '726465',
        '724670',
        '726435',
        '724675',
        '725156',
        '722700',
        '723170',
        '727750',
        '725710',
        '722435',
        '725037',
        '724518',
        '724030',
        '727670',
        '723860',
        '722670',
        '724220',
        '725030',
        '725510',
        '722050',
        '722340',
        '723340',
        '722260',
        '722020',
        '726360',
        '722486',
        '723894',
        '722230',
        '726410',
        '722310',
        '724765',
        '724930',
        '726225',
        '722780',
        '725200',
        '723060',
        '724880',
        '724110',
        '722680',
        '724940',
        '724945',
        '724839',
        '725190',
        '722140',
        '725360',
        '723418',
        '723260',
        '723436',
        '747040']
=end

ftp = Net::FTP.new
ftp.connect("ftp.ncdc.noaa.gov", 21)
ftp.login("anonymous", "zsvoboda@gmail.com")
ftp.passive = true


%w(2016 2017 2018).each do |year|
  ftp.chdir("/pub/data/noaa/isd-lite/#{year}")
  filenames = ftp.nlst('*')
  filenames.each do |filename|
    if usaf.include? filename[0..5] then
      puts "getting file #{filename}"
      ftp.getbinaryfile(filename, "../../data/#{filename[0..5]}-#{year}.tsv.gz")
    end
  end
end


# un-gzips the given IO, returning the
# decompressed version as a StringIO
def ungzip(filename)
  file = File.new(filename, "r")
  z = Zlib::GzipReader.new(file)
  unzipped = StringIO.new(z.read)
  z.close
  unzipped
end

out_file = "../../data/weather_data.csv"

open(out_file, 'w') do |f|
  f.puts "usaf,date,hour,air_temp,dew_point,pressure,wind_dir,wind_speed,condition,precipitation_1h,precipitation_6h"
  Dir.glob('../../data/*.tsv.gz').select {|e| File.file? e}.each do |file|
    puts "Processing #{file}"
    content = ungzip(file)
    content.each_line.map do |l|
      f.write "#{file[11..16]},#{l.sub!(/^(\d\d\d\d) (\d\d) (\d\d)/, '\1-\2-\3').gsub!(/[ ]+/, ',').gsub('-9999', '')}"
    end
  end
end



